import { describe, it, expect, vi, beforeEach, afterEach } from 'vitest';
import { render, screen, waitFor, act } from '@testing-library/react';
import userEvent from '@testing-library/user-event';
import App from './App';
import { useGameStore } from './stores/gameStore';
import { useUIStore } from './stores/uiStore';

// Mock requestAnimationFrame for fake timers
let rafCallbacks: FrameRequestCallback[] = [];
let rafId = 0;

global.requestAnimationFrame = vi.fn((callback: FrameRequestCallback) => {
  const id = ++rafId;
  rafCallbacks.push(callback);
  return id;
});

global.cancelAnimationFrame = vi.fn((id: number) => {
  // Simple implementation for tests
});

// Helper to flush RAF callbacks
const flushRAF = () => {
  const callbacks = [...rafCallbacks];
  rafCallbacks = [];
  callbacks.forEach(cb => cb(performance.now()));
};

// Mock DEV_CONFIG to disable auto-start for controlled testing
vi.mock('./config/dev', () => ({
  DEV_CONFIG: {
    AUTO_START_LEVEL: null,
    TEST_ENEMIES: false,
    TEST_ENEMIES_COUNT: 0,
    TEST_ENEMIES_DISTANCE: 0,
    SHOW_DEBUG_INFO: false,
    SHOW_COORDINATES: false,
    SHOW_PATH_COORDINATES: false,
    GAME_SPEED: 1,
  },
}));

describe('App Integration Tests', () => {
  beforeEach(() => {
    vi.useFakeTimers();
    rafCallbacks = [];
    rafId = 0;
    // Ğ¡Ğ±Ñ€Ğ°ÑÑ‹Ğ²Ğ°ĞµĞ¼ Zustand stores Ğ¿ĞµÑ€ĞµĞ´ ĞºĞ°Ğ¶Ğ´Ñ‹Ğ¼ Ñ‚ĞµÑÑ‚Ğ¾Ğ¼
    useGameStore.getState().resetGame();
    useUIStore.setState({ selectedTowerLevel: null, isInitialized: false });
  });

  afterEach(() => {
    vi.restoreAllMocks();
    vi.useRealTimers();
    rafCallbacks = [];
  });

  describe('Initial State', () => {
    it('should render level select screen on initial load', () => {
      render(<App />);

      expect(screen.getByText('ğŸ° Tower Defense')).toBeInTheDocument();
      expect(screen.getByText('Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ ÑƒÑ€Ğ¾Ğ²ĞµĞ½ÑŒ ÑĞ»Ğ¾Ğ¶Ğ½Ğ¾ÑÑ‚Ğ¸')).toBeInTheDocument();
    });

    it('should show all 10 levels', () => {
      render(<App />);

      for (let i = 1; i <= 10; i++) {
        expect(screen.getByText(i.toString())).toBeInTheDocument();
      }
    });
  });

  describe('Level Selection and Initialization', () => {
    it('should start game when level is selected', async () => {
      const user = userEvent.setup({ delay: null });
      render(<App />);

      const level1Button = screen.getByText('1').closest('button');
      await user.click(level1Button!);

      // Advance timers to process setTimeout in initializeGame
      await act(async () => {
        vi.advanceTimersByTime(150);
      });

      // Should transition to game screen
      expect(screen.queryByText('ğŸ° Tower Defense')).not.toBeInTheDocument();

      // Should show game UI
      expect(screen.getByText(/ğŸ’°/)).toBeInTheDocument();
      expect(screen.getByText(/â¤ï¸/)).toBeInTheDocument();
    });

    it('should initialize with correct starting money for level 1', async () => {
      const user = userEvent.setup({ delay: null });
      render(<App />);

      const level1Button = screen.getByText('1').closest('button');
      await user.click(level1Button!);

      await act(async () => {
        vi.advanceTimersByTime(150);
      });

      expect(screen.getByText('300')).toBeInTheDocument(); // Level 1 starting money
    });

    it('should initialize with correct starting lives for level 1', async () => {
      const user = userEvent.setup({ delay: null });
      render(<App />);

      const level1Button = screen.getByText('1').closest('button');
      await user.click(level1Button!);

      await act(async () => {
        vi.advanceTimersByTime(150);
      });

      expect(screen.getByText('20')).toBeInTheDocument(); // Level 1 starting lives
    });
    });
  });

  describe('Tower Placement', () => {
    it('should allow selecting a tower', async () => {
      const user = userEvent.setup({ delay: null });
      render(<App />);

      // Select level
      const level1Button = screen.getByText('1').closest('button');
      await user.click(level1Button!);

      await act(async () => {
        vi.advanceTimersByTime(150);
      });

      expect(screen.getByText('Ğ¢1')).toBeInTheDocument();

      // Select tower
      const tower1Button = screen.getByText('Ğ¢1').closest('button');
      await user.click(tower1Button!);

      // Should show hint
      expect(screen.getByText('ĞšĞ»Ğ¸ĞºĞ½Ğ¸Ñ‚Ğµ Ğ½Ğ° ĞºĞ°Ñ€Ñ‚Ğµ, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¿Ğ¾ÑÑ‚Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ±Ğ°ÑˆĞ½Ñ')).toBeInTheDocument();
    });

    it('should deduct money when placing a tower', async () => {
      const user = userEvent.setup({ delay: null });
      render(<App />);

      // Select level
      const level1Button = screen.getByText('1').closest('button');
      await user.click(level1Button!);

      await act(async () => {
        vi.advanceTimersByTime(150);
      });

      expect(screen.getByText('300')).toBeInTheDocument();

      // Select tower (cost 50)
      const tower1Button = screen.getByText('Ğ¢1').closest('button');
      await user.click(tower1Button!);

      // Click on canvas
      const canvas = document.querySelector('canvas')!;
      canvas.getBoundingClientRect = vi.fn(() => ({
        left: 0,
        top: 0,
        right: 800,
        bottom: 600,
        width: 800,
        height: 600,
        x: 0,
        y: 0,
        toJSON: () => {},
      }));

      await user.click(canvas);

      // Money should be deducted
      expect(screen.getByText('250')).toBeInTheDocument(); // 300 - 50
    });

      // Money should be deducted
      expect(screen.getByText('250')).toBeInTheDocument(); // 300 - 50
    });
  });

  describe('Wave Management', () => {
    it('should show start wave button', async () => {
      const user = userEvent.setup({ delay: null });
      render(<App />);

      const level1Button = screen.getByText('1').closest('button');
      await user.click(level1Button!);

      await act(async () => {
        vi.advanceTimersByTime(150);
      });

      expect(screen.getByText('ĞĞ°Ñ‡Ğ°Ñ‚ÑŒ Ğ²Ğ¾Ğ»Ğ½Ñƒ')).toBeInTheDocument();
    });

    it('should start wave when button is clicked', async () => {
      const user = userEvent.setup({ delay: null });
      render(<App />);

      const level1Button = screen.getByText('1').closest('button');
      await user.click(level1Button!);

      await waitFor(() => {
        const startButton = screen.getByText('ĞĞ°Ñ‡Ğ°Ñ‚ÑŒ Ğ²Ğ¾Ğ»Ğ½Ñƒ');
        expect(startButton).toBeInTheDocument();
      });

      const startButton = screen.getByText('ĞĞ°Ñ‡Ğ°Ñ‚ÑŒ Ğ²Ğ¾Ğ»Ğ½Ñƒ');
      await user.click(startButton);

      // Wave count should update
      await waitFor(() => {
        expect(screen.getByText('1/2')).toBeInTheDocument(); // Level 1 has 2 waves
      });
    });
  });

  describe('Game Pause/Resume', () => {
    it('should show pause button during gameplay', async () => {
      const user = userEvent.setup({ delay: null });
      render(<App />);

      const level1Button = screen.getByText('1').closest('button');
      await user.click(level1Button!);

      await waitFor(() => {
        expect(screen.getByText('â¸ ĞŸĞ°ÑƒĞ·Ğ°')).toBeInTheDocument();
      });
    });

    it('should pause game when pause button is clicked', async () => {
      const user = userEvent.setup({ delay: null });
      render(<App />);

      const level1Button = screen.getByText('1').closest('button');
      await user.click(level1Button!);

      await waitFor(() => {
        const pauseButton = screen.getByText('â¸ ĞŸĞ°ÑƒĞ·Ğ°');
        expect(pauseButton).toBeInTheDocument();
      });

      const pauseButton = screen.getByText('â¸ ĞŸĞ°ÑƒĞ·Ğ°');
      await user.click(pauseButton);

      await waitFor(() => {
        expect(screen.getByText('â–¶ï¸ ĞŸÑ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ¸Ñ‚ÑŒ')).toBeInTheDocument();
      });
    });

    it('should resume game when resume button is clicked', async () => {
      const user = userEvent.setup({ delay: null });
      render(<App />);

      const level1Button = screen.getByText('1').closest('button');
      await user.click(level1Button!);

      await waitFor(() => {
        const pauseButton = screen.getByText('â¸ ĞŸĞ°ÑƒĞ·Ğ°');
        expect(pauseButton).toBeInTheDocument();
      });

      // Pause
      const pauseButton = screen.getByText('â¸ ĞŸĞ°ÑƒĞ·Ğ°');
      await user.click(pauseButton);

      await waitFor(() => {
        expect(screen.getByText('â–¶ï¸ ĞŸÑ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ¸Ñ‚ÑŒ')).toBeInTheDocument();
      });

      // Resume
      const resumeButton = screen.getByText('â–¶ï¸ ĞŸÑ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ¸Ñ‚ÑŒ');
      await user.click(resumeButton);

      await waitFor(() => {
        expect(screen.getByText('â¸ ĞŸĞ°ÑƒĞ·Ğ°')).toBeInTheDocument();
      });
    });
  });

  describe('Canvas Rendering', () => {
    it('should render game canvas', async () => {
      const user = userEvent.setup({ delay: null });
      render(<App />);

      const level1Button = screen.getByText('1').closest('button');
      await user.click(level1Button!);

      await waitFor(() => {
        const canvas = document.querySelector('canvas');
        expect(canvas).toBeInTheDocument();
      });
    });

    it('should have correct canvas dimensions', async () => {
      const user = userEvent.setup({ delay: null });
      render(<App />);

      const level1Button = screen.getByText('1').closest('button');
      await user.click(level1Button!);

      await waitFor(() => {
        const canvas = document.querySelector('canvas');
        expect(canvas).toHaveAttribute('width', '800');
        expect(canvas).toHaveAttribute('height', '600');
      });
    });
  });

  describe('Tower Selection', () => {
    it('should disable expensive towers when insufficient money', async () => {
      const user = userEvent.setup({ delay: null });
      render(<App />);

      const level1Button = screen.getByText('1').closest('button');
      await user.click(level1Button!);

      await waitFor(() => {
        expect(screen.getByText('300')).toBeInTheDocument();
      });

      // Tower 3 costs 350, should be disabled with 300 money
      const tower3Button = screen.getByText('Ğ¢3').closest('button');
      expect(tower3Button).toBeDisabled();
    });

    it('should enable all towers when sufficient money', async () => {
      const user = userEvent.setup({ delay: null });
      render(<App />);

      // Start level 5 which has 500 starting money
      const level5Button = screen.getByText('5').closest('button');
      await user.click(level5Button!);

      await waitFor(() => {
        expect(screen.getByText('500')).toBeInTheDocument();
      });

      // All towers should be enabled
      const tower1Button = screen.getByText('Ğ¢1').closest('button');
      const tower2Button = screen.getByText('Ğ¢2').closest('button');
      const tower3Button = screen.getByText('Ğ¢3').closest('button');

      expect(tower1Button).not.toBeDisabled();
      expect(tower2Button).not.toBeDisabled();
      expect(tower3Button).not.toBeDisabled();
    });
  });

  describe('Level Display', () => {
    it('should display correct level number', async () => {
      const user = userEvent.setup({ delay: null });
      render(<App />);

      const level3Button = screen.getByText('3').closest('button');
      await user.click(level3Button!);

      await waitFor(() => {
        expect(screen.getByText('Ğ£Ñ€. 3')).toBeInTheDocument();
      });
    });

    it('should display correct total waves', async () => {
      const user = userEvent.setup({ delay: null });
      render(<App />);

      const level3Button = screen.getByText('3').closest('button');
      await user.click(level3Button!);

      await waitFor(() => {
        expect(screen.getByText('0/3')).toBeInTheDocument(); // Level 3 has 3 waves
      });
    });
  });

  describe('Multiple Tower Placement', () => {
    it('should allow placing multiple towers', async () => {
      const user = userEvent.setup({ delay: null });
      render(<App />);

      // Start level 5 with 500 money
      const level5Button = screen.getByText('5').closest('button');
      await user.click(level5Button!);

      await waitFor(() => {
        expect(screen.getByText('500')).toBeInTheDocument();
      });

      const canvas = document.querySelector('canvas')!;
      canvas.getBoundingClientRect = vi.fn(() => ({
        left: 0,
        top: 0,
        right: 800,
        bottom: 600,
        width: 800,
        height: 600,
        x: 0,
        y: 0,
        toJSON: () => {},
      }));

      // Place first tower (cost 50)
      const tower1Button = screen.getByText('Ğ¢1').closest('button');
      await user.click(tower1Button!);
      await user.click(canvas);

      await waitFor(() => {
        expect(screen.getByText('450')).toBeInTheDocument(); // 500 - 50
      });

      // Place second tower (cost 50)
      await user.click(tower1Button!);
      await user.click(canvas);

      await waitFor(() => {
        expect(screen.getByText('400')).toBeInTheDocument(); // 450 - 50
      });
    });
  });
});
